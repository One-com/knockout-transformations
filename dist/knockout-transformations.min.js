/*! Knockout transformations plugin - version 1.6.0
------------------------------------------------------------------------------
Copyright 2015 One.com

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
------------------------------------------------------------------------------
*/
!function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout")):"function"==typeof define&&define.amd?define(["knockout"],a):a(window.ko)}(function(a){function b(a,b,c,d,e,f,g){this.inputItem=b,this.stateArrayIndex=c,this.mappingOptions=e,this.arrayOfState=f,this.outputObservableArray=g,this.outputArray=this.outputObservableArray.peek(),this.isIncluded=null,this.suppressNotification=!1,this.outputArrayIndex=a.observable(d),this.disposeFuncFromMostRecentMapping=null,this.mappedValueComputed=a.computed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function c(a,b){if(!a)return null;switch(a.status){case"added":return a.index;case"deleted":return a.index+b;default:throw new Error("Unknown diff status: "+a.status)}}function d(a,c,d,e,f,g,h,i,j){var k="number"==typeof c.moved,l=k?d[c.moved]:new b(a,c.value,e,f,g,h,i);return h.splice(e,0,l),l.isIncluded&&j.splice(f,0,l.mappedValueComputed.peek()),k&&(l.stateArrayIndex=e,l.setOutputArrayIndexSilently(f)),l}function e(a,b,c,d,e){var f=b.splice(c,1)[0];f.isIncluded&&e.splice(d,1),"number"!=typeof a.moved&&f.dispose()}function f(a,b,c){return a.stateArrayIndex=b,a.setOutputArrayIndexSilently(c),c+(a.isIncluded?1:0)}function g(a,b){for(var c={},d=0;d<a.length;d++){var e=a[d];"added"===e.status&&"number"==typeof e.moved&&(c[e.moved]=b[e.moved])}return c}function h(a,b,c){return c.length&&b[a.index]?b[a.index].outputArrayIndex.peek():c.length}function i(a,b,i,j,k,l){return b.subscribe(function(b){if(b.length){k.valueWillMutate();for(var m=g(b,i),n=0,o=b[0],p=0,q=o&&h(o,i,j),r=o.index;o||r<i.length;r++)if(c(o,p)===r){switch(o.status){case"added":var s=d(a,o,m,r,q,l,i,k,j);s.isIncluded&&q++,p++;break;case"deleted":e(o,i,r,q,j),p--,r--;break;default:throw new Error("Unknown diff status: "+o.status)}n++,o=b[n]}else r<i.length&&(q=f(i[r],r,q));k.valueHasMutated()}},null,"arrayChange")}function j(a,c){var d=this,e=[],f=[],g=a.observableArray(f),h=d.peek();if("function"==typeof c&&(c={mapping:c}),c.mappingWithDisposeCallback){if(c.mapping||c.disposeItem)throw new Error("'mappingWithDisposeCallback' cannot be used in conjunction with 'mapping' or 'disposeItem'.")}else if(!c.mapping)throw new Error("Specify either 'mapping' or 'mappingWithDisposeCallback'.");for(var j=0;j<h.length;j++){var k=h[j],l=new b(a,k,j,f.length,c,e,g),m=l.mappedValueComputed.peek();e.push(l),l.isIncluded&&f.push(m)}var n=i(a,d,e,f,g,c),o=g;"throttle"in c&&(o=a.pureComputed(g).extend({throttle:c.throttle}));var p=a.pureComputed(o).extend({trackArrayChanges:!0}),q=p.dispose;return p.dispose=function(){n.dispose(),a.utils.arrayForEach(e,function(a){a.dispose()}),q.call(this,arguments)},A(a,p),p}function k(a,b){"function"==typeof b&&(b={mapping:b});var c=b.mapping;return b.mapping=function(a){return c(a)?a:C},j.call(this,a,b)}function l(a,b){var c=s.Descending;Array.isArray(a)||(a=[a],b=[b]);for(var d,e,f=0;f<a.length;f+=1){if(d=a[f],e=b[f],d instanceof c){if(!(e instanceof c))return!1;d=d.value,e=e.value}if(d!==e)return!1}return!0}function m(a,b){var c=s.Descending;Array.isArray(a)||(a=[a],b=[b]);for(var d,e,f=0;f<a.length;f+=1)if(d=a[f],e=b[f],d instanceof c){if(d.value>e.value)return-1;if(d.value<e.value)return 1}else{if(e>d)return-1;if(d>e)return 1}return 0}function n(a){var b=s.Descending;return function(c,d){var e=a(c,b.create),f=a(d,b.create);return m(e,f)}}function o(a,b,c){for(var d,e=-1,f=a.length;f-e>1;){d=e+f>>>1;var g=c(a[d],b);if(0>g)e=d;else if(f=d,!g)break}return f===a.length||c(a[f],b)?-f-1:f}function p(a,b,c){for(var d,e=-1,f=a.length;f-e>1;)d=e+f>>>1,c(a[d],b)<0?e=d:f=d;return f}function q(a,b,c){var d=o(a,b,c);if(0>d||a.length<=d||0!==c(a[d],b))return-1;for(var e=d;d-1>=0&&0===c(a[d-1],b);)d-=1;for(;e>=d;){if(a[d]===b)return d;d+=1}for(;d<a.length;){if(0!==c(a[d],b))return-1;if(a[d]===b)return d;d+=1}return-1}function r(a,b){var c=a.ko;this.transformation=a,this.inputItem=b,this.mappedValueComputed=c.computed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function s(a,b,c){var d=this;this.ko=a,this.options=c,this.mapping=c.mapping,this.comparefn=n(this.mapping),this.stateItems=a.utils.arrayMap(b.peek(),function(a){return new r(d,a)}),this.stateItems.sort(function(a,b){return m(a.mappedValueComputed(),b.mappedValueComputed())}),this.outputObservable=a.observable(a.utils.arrayMap(this.stateItems,function(a){return a.inputItem}));var e=b.subscribe(this.onStructuralChange,this,"arrayChange"),f=a.pureComputed(this.outputObservable);"throttle"in c&&(f=f.extend({throttle:c.throttle})),this.output=f.extend({trackArrayChanges:!0});var g=this.output.dispose;this.output.dispose=function(){e.dispose(),a.utils.arrayForEach(d.stateItems,function(a){a.dispose()}),g.call(this,arguments)},A(a,this.output)}function t(a,b){"function"==typeof b&&(b={mapping:b});var c=new s(a,this,b);return c.output}function u(a,b,c){var d=this;this.ko=a,this.options=c,this.outputObservable=a.observable({}),this.stateItems={},this.mapping=function(a){return[].concat(c.mapping(a))};for(var e=b.peek(),f=0;f<e.length;f+=1)this.addToIndex(e[f],f);var g=b.subscribe(this.onStructuralChange,this,"arrayChange"),h=a.pureComputed(this.outputObservable);"throttle"in c&&(h=h.extend({throttle:c.throttle})),this.output=h;var i=this.output.dispose;this.output.dispose=function(){g.dispose();for(var a in d.stateItems)d.stateItems.hasOwnProperty(a)&&d.stateItems[a].dispose();i.call(this,arguments)}}function v(a,b){this.transformation=a,this.inputItem=b,this.mappedValueComputed=a.ko.computed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function w(a,b,c){u.call(this,a,b,c)}function x(a,b){v.call(this,a,b)}function y(a,b){"function"==typeof b&&(b={mapping:b,unique:!1});var c=b.unique?new w(a,this,b):new u(a,this,b);return c.output}function z(a,b){"function"==typeof b&&(b={mapping:b}),b.unique=!0;var c=new w(a,this,b);return c.output}function A(a,b){return a.utils.extend(b,a.transformations.fn),b}function B(a){function b(a,b){return function(){return b.apply(this,[a].concat(Array.prototype.slice.call(arguments,0)))}}a.transformations=a.transformations||{fn:{},_exclusionMarker:C},a.utils.extend(a.transformations.fn,{map:b(a,j),sortBy:b(a,t),indexBy:b(a,y),uniqueIndexBy:b(a,z),filter:b(a,k)}),A(a,a.observableArray.fn)}var C={};b.prototype.dispose=function(){this.mappedValueComputed.dispose(),this.disposeResultFromMostRecentEvaluation()},b.prototype.disposeResultFromMostRecentEvaluation=function(){if(this.disposeFuncFromMostRecentMapping&&(this.disposeFuncFromMostRecentMapping(),this.disposeFuncFromMostRecentMapping=null),this.mappingOptions.disposeItem){var a=this.mappedValueComputed();this.mappingOptions.disposeItem(a)}},b.prototype.mappingEvaluator=function(){null!==this.isIncluded&&this.disposeResultFromMostRecentEvaluation();var a;if(this.mappingOptions.mapping)a=this.mappingOptions.mapping(this.inputItem,this.outputArrayIndex);else{if(!this.mappingOptions.mappingWithDisposeCallback)throw new Error("No mapping callback given.");var b=this.mappingOptions.mappingWithDisposeCallback(this.inputItem,this.outputArrayIndex);if(!("mappedValue"in b))throw new Error("Return value from mappingWithDisposeCallback should have a 'mappedItem' property.");a=b.mappedValue,this.disposeFuncFromMostRecentMapping=b.dispose}return null===this.isIncluded&&(this.isIncluded=a!==C),a},b.prototype.updateInclusion=function(){for(var a=this.outputArrayIndex.peek(),b=this.outputArray,c=this.stateArrayIndex;c<this.arrayOfState.length;c++){var d=this.arrayOfState[c];d.setOutputArrayIndexSilently(a);var e=d.mappingEvaluator(),f=e!==C;f&&(b[a]=e,a+=1),d.previousMappedValue=e,d.isIncluded=f}a<b.length&&(b.length=a)},b.prototype.onMappingResultChanged=function(a){if(a!==this.previousMappedValue){this.suppressNotification||this.outputObservableArray.valueWillMutate();var b=a!==C;this.isIncluded!==b?this.updateInclusion():(b&&(this.outputArray[this.outputArrayIndex.peek()]=a),this.previousMappedValue=a),this.suppressNotification||this.outputObservableArray.valueHasMutated()}},b.prototype.setOutputArrayIndexSilently=function(a){this.suppressNotification=!0,this.outputArrayIndex(a),this.suppressNotification=!1},r.prototype.dispose=function(){var a=this.mappedValueComputed();this.mappedValueComputed.dispose(),this.transformation.options.disposeItem&&this.transformation.options.disposeItem(a)},r.prototype.mappingEvaluator=function(){return this.transformation.mapping(this.inputItem,s.Descending.create)},r.prototype.onMappingResultChanged=function(a){if(!l(a,this.previousMappedValue)){var b=this.transformation,c=b.outputObservable,d=c.peek(),e=b.stateItems,f=q(e,this,n(function(a){return a.previousMappedValue}));if(e[f]===this){c.valueWillMutate(),d.splice(f,1),e.splice(f,1);var g=p(d,this.inputItem,b.comparefn);d.splice(g,0,this.inputItem),e.splice(g,0,this),this.previousMappedValue=a,c.valueHasMutated()}else{var h=b.ko;h.utils.arrayForEach(e,function(a){a.previousMappedValue=a.mappingEvaluator()}),e.sort(n(function(a){return a.previousMappedValue})),d=[],h.utils.arrayForEach(e,function(a){d.push(a.inputItem)}),c(d)}}},s.Descending=function(a){this.value=a},s.Descending.create=function(a){return new s.Descending(a)},s.prototype.onStructuralChange=function(a){if(a.length){this.outputObservable.valueWillMutate();var b=this,c=this.ko,d=[],e=[];c.utils.arrayForEach(a,function(a){if("number"!=typeof a.moved)switch(a.status){case"added":d.push(a);break;case"deleted":e.push(a)}});var f=this.outputObservable.peek();c.utils.arrayForEach(e,function(a){var c=q(f,a.value,b.comparefn);-1!==c&&(f.splice(c,1),b.stateItems[c].dispose(),b.stateItems.splice(c,1))}),0===e.length&&0===this.stateItems.length?(this.stateItems=c.utils.arrayMap(d,function(a){return new r(b,a.value)}),this.stateItems.sort(function(a,b){return m(a.mappedValueComputed(),b.mappedValueComputed())}),c.utils.arrayForEach(this.stateItems,function(a){f.push(a.inputItem)})):c.utils.arrayForEach(d,function(a){var c=p(f,a.value,b.comparefn),d=new r(b,a.value);f.splice(c,0,d.inputItem),b.stateItems.splice(c,0,d)}),this.outputObservable.valueHasMutated()}},u.prototype.arraysEqual=function(a,b){var c=this.ko;if(a===b)return!0;if("undefined"==typeof a||"undefined"==typeof b)return!1;if(a.length!==b.length)return!1;for(var d=0;d<a.length;d+=1)if(c.observable.fn.equalityComparer&&c.isObservable(a[d])&&!c.observable.fn.equalityComparer(a[d],b[d])||a[d]!==b[d])return!1;return!0},u.prototype.appendToEntry=function(a,b,c){var d=a[b];d||(d=a[b]=[]),d.push(c)},u.prototype.removeFromEntry=function(a,b,c){var d=a[b];if(d){var e=d.indexOf(c);-1!==e&&(1===d.length?delete a[b]:d.splice(e,1))}},u.prototype.insertByKeyAndItem=function(a,b,c){this.appendToEntry(a,b,c)},u.prototype.removeByKeyAndItem=function(a,b,c){this.removeFromEntry(a,b,c)},u.prototype.addStateItemToIndex=function(a){var b=this.mapping(a.inputItem)[0];this.appendToEntry(this.stateItems,b,a)},u.prototype.findStateItem=function(a){var b=this.ko,c=this.mapping(a)[0],d=this.stateItems[c];if(!d)return null;var e=b.utils.arrayFilter(d,function(b){return b.inputItem===a});return e[0]||null},u.prototype.removeStateItem=function(a){var b=a.mappedValueComputed()[0];this.removeFromEntry(this.stateItems,b,a),a.dispose()},u.prototype.addToIndex=function(a){var b=this,c=this.ko,d=this.mapping(a),e=this.outputObservable.peek();c.utils.arrayForEach(d,function(c){b.insertByKeyAndItem(e,c,a)});var f=new v(this,a);this.addStateItemToIndex(f)},u.prototype.removeItem=function(a){var b=this,c=this.ko,d=this.findStateItem(a);if(d){var e=d.mappedValueComputed(),f=this.outputObservable.peek();c.utils.arrayForEach(e,function(c){b.removeByKeyAndItem(f,c,a)}),this.removeStateItem(d)}},u.prototype.onStructuralChange=function(a){var b=this;if(a.length){var c=this.ko,d=[],e=[];c.utils.arrayForEach(a,function(a){if("number"!=typeof a.moved)switch(a.status){case"added":d.push(a);break;case"deleted":e.push(a)}}),c.utils.arrayForEach(e,function(a){b.removeItem(a.value,a.index)}),c.utils.arrayForEach(d,function(a){b.addToIndex(a.value,a.index)}),this.outputObservable.valueHasMutated()}},v.prototype.dispose=function(){var a=this.mappedValueComputed();this.mappedValueComputed.dispose(),this.transformation.options.disposeItem&&this.transformation.options.disposeItem(a)},v.prototype.mappingEvaluator=function(){return this.transformation.mapping(this.inputItem)},v.prototype.onMappingResultChanged=function(a){var b=this.transformation;if(!b.arraysEqual(this.newValue,this.previousMappedValue)){var c=b.outputObservable,d=c.peek();c.valueWillMutate(),b.removeByKeyAndItem(d,this.previousMappedValue,this.inputItem),b.removeByKeyAndItem(b.stateItems,this.previousMappedValue,this),b.insertByKeyAndItem(d,a,this.inputItem),b.addStateItemToIndex(this),this.previousMappedValue=a,c.valueHasMutated()}},a.utils.extend(w.prototype,u.prototype),w.prototype.insertByKeyAndItem=function(a,b,c){if(b in a)throw new Error("Unique indexes requires items must map to different keys; duplicate key: "+b);a[b]=c},w.prototype.removeByKeyAndItem=function(a,b){delete a[b]},w.prototype.addStateItemToIndex=function(a){var b=a.mappedValueComputed()[0];this.stateItems[b]=a},w.prototype.findStateItem=function(a){var b=this.mapping(a)[0];return this.stateItems[b]||null},w.prototype.removeStateItem=function(a){var b=a.mappedValueComputed()[0];this.stateItems[b]===a&&delete this.stateItems[b],a.dispose()},w.prototype.addToIndex=function(a){var b=this,c=this.ko,d=this.mapping(a),e=this.outputObservable.peek();c.utils.arrayForEach(d,function(c){b.insertByKeyAndItem(e,c,a)});var f=new x(this,a);this.addStateItemToIndex(f)},w.prototype.removeItem=function(a){var b=this,c=this.ko,d=this.findStateItem(a);if(d){var e=d.mappedValueComputed(),f=this.outputObservable.peek();c.utils.arrayForEach(e,function(c){b.removeByKeyAndItem(f,c,a)}),this.removeStateItem(d)}},a.utils.extend(x.prototype,v.prototype),B(a)});